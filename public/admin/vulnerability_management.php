<?php
session_start();
require_once '../../src/db/db.php';
require_once '../../src/log/log_function.php';

// ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
if (!isset($_SESSION['admin'])) {
    header("Location: ../login.php");
    exit();
}

$username = $_SESSION['admin'] ?? '';

// ìƒíƒœ ë³€ê²½ ì²˜ë¦¬
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_status'])) {
    $report_id = (int)$_POST['report_id'];
    $new_status = $_POST['new_status'];
    $admin_notes = trim($_POST['admin_notes'] ?? '');
    
    $stmt = $pdo->prepare("UPDATE vulnerability_reports SET status = ?, admin_notes = ? WHERE id = ?");
    $stmt->execute([$new_status, $admin_notes, $report_id]);
    
    writeLog($pdo, $username, 'ì·¨ì•½ì ìƒíƒœë³€ê²½', 'ì„±ê³µ', "ID: $report_id, ìƒíƒœ: $new_status");
    echo "<script>alert('ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.'); location.href='vulnerability_management.php';</script>";
    exit();
}

// ì¼ê´„ ì²˜ë¦¬
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['bulk_action'])) {
    $selected_reports = $_POST['selected_reports'] ?? [];
    $bulk_status = $_POST['bulk_status'];
    $bulk_notes = trim($_POST['bulk_notes'] ?? '');
    
    if (!empty($selected_reports)) {
        $placeholders = str_repeat('?,', count($selected_reports) - 1) . '?';
        $stmt = $pdo->prepare("UPDATE vulnerability_reports SET status = ?, admin_notes = ? WHERE id IN ($placeholders)");
        $params = array_merge([$bulk_status, $bulk_notes], $selected_reports);
        $stmt->execute($params);
        
        writeLog($pdo, $username, 'ì·¨ì•½ì ì¼ê´„ì²˜ë¦¬', 'ì„±ê³µ', "ê°œìˆ˜: " . count($selected_reports) . ", ìƒíƒœ: $bulk_status");
        echo "<script>alert('ì¼ê´„ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); location.href='vulnerability_management.php';</script>";
        exit();
    }
}

// í•„í„°ë§
$status_filter = $_GET['status'] ?? '';
$severity_filter = $_GET['severity'] ?? '';
$category_filter = $_GET['category'] ?? '';
$search_term = $_GET['search'] ?? '';

$where_conditions = [];
$params = [];

if ($status_filter) {
    $where_conditions[] = "status = ?";
    $params[] = $status_filter;
}

if ($severity_filter) {
    $where_conditions[] = "severity = ?";
    $params[] = $severity_filter;
}

if ($category_filter) {
    $where_conditions[] = "category = ?";
    $params[] = $category_filter;
}

if ($search_term) {
    $where_conditions[] = "(title LIKE ? OR description LIKE ? OR reported_by LIKE ?)";
    $search_param = "%$search_term%";
    $params[] = $search_param;
    $params[] = $search_param;
    $params[] = $search_param;
}

$where_sql = '';
if (!empty($where_conditions)) {
    $where_sql = 'WHERE ' . implode(' AND ', $where_conditions);
}

// ì·¨ì•½ì  ëª©ë¡ ì¡°íšŒ
$sql = "SELECT * FROM vulnerability_reports $where_sql ORDER BY 
        CASE 
            WHEN severity = 'critical' THEN 1
            WHEN severity = 'high' THEN 2
            WHEN severity = 'medium' THEN 3
            WHEN severity = 'low' THEN 4
        END,
        created_at DESC";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$reports = $stmt->fetchAll();

// í†µê³„
$total_reports = $pdo->query("SELECT COUNT(*) FROM vulnerability_reports")->fetchColumn();
$pending_reports = $pdo->query("SELECT COUNT(*) FROM vulnerability_reports WHERE status = 'pending'")->fetchColumn();
$critical_reports = $pdo->query("SELECT COUNT(*) FROM vulnerability_reports WHERE severity = 'critical'")->fetchColumn();
$fixed_reports = $pdo->query("SELECT COUNT(*) FROM vulnerability_reports WHERE status = 'fixed'")->fetchColumn();
$investigating_reports = $pdo->query("SELECT COUNT(*) FROM vulnerability_reports WHERE status = 'investigating'")->fetchColumn();
?>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì·¨ì•½ì  ê´€ë¦¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .management-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; color: #005BAC; }
        .stat-label { color: #666; margin-top: 5px; }
        .filter-section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .filter-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 5px; font-weight: 600; }
        .filter-group select, .filter-group input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-filter { background: #005BAC; color: #fff; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-filter:hover { background: #004a8c; }
        .bulk-actions { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .bulk-form { display: grid; grid-template-columns: 1fr auto auto auto; gap: 15px; align-items: end; }
        .reports-list { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
        .report-item { border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .report-title { font-size: 18px; font-weight: 600; color: #333; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .severity-critical { background: #ff4444; color: #fff; }
        .severity-high { background: #ff8800; color: #fff; }
        .severity-medium { background: #ffcc00; color: #333; }
        .severity-low { background: #00cc00; color: #fff; }
        .status-pending { background: #ffcc00; color: #333; }
        .status-investigating { background: #0099ff; color: #fff; }
        .status-fixed { background: #00cc00; color: #fff; }
        .status-rejected { background: #ff4444; color: #fff; }
        .status-form { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .status-form select, .status-form textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .btn-update { background: #005BAC; color: #fff; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-update:hover { background: #004a8c; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; }
        .checkbox-group input[type="checkbox"] { margin: 0; }
        .priority-indicator { width: 4px; height: 100%; position: absolute; left: 0; top: 0; }
        .priority-critical { background: #ff4444; }
        .priority-high { background: #ff8800; }
        .priority-medium { background: #ffcc00; }
        .priority-low { background: #00cc00; }
        .report-item { position: relative; padding-left: 20px; }
        .quick-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-quick { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-investigate { background: #0099ff; color: #fff; }
        .btn-fix { background: #00cc00; color: #fff; }
        .btn-reject { background: #ff4444; color: #fff; }
    </style>
</head>
<body>
    <div class="management-container">
        <h1>ğŸ”’ ì·¨ì•½ì  ê´€ë¦¬</h1>
        <p>ì œë³´ëœ ì·¨ì•½ì ë“¤ì„ ê²€í† í•˜ê³  ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number"><?= $total_reports ?></div>
                <div class="stat-label">ì´ ì œë³´</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?= $pending_reports ?></div>
                <div class="stat-label">ê²€í†  ëŒ€ê¸°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?= $critical_reports ?></div>
                <div class="stat-label">ì¹˜ëª…ì  ì·¨ì•½ì </div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?= $investigating_reports ?></div>
                <div class="stat-label">ì¡°ì‚¬ ì¤‘</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?= $fixed_reports ?></div>
                <div class="stat-label">ìˆ˜ì • ì™„ë£Œ</div>
            </div>
        </div>
        
        <div class="filter-section">
            <h3>ğŸ” í•„í„° ë° ê²€ìƒ‰</h3>
            <form method="GET" class="filter-form">
                <div class="filter-group">
                    <label for="search">ê²€ìƒ‰</label>
                    <input type="text" id="search" name="search" value="<?= htmlspecialchars($search_term) ?>" placeholder="ì œëª©, ì„¤ëª…, ì œë³´ì ê²€ìƒ‰">
                </div>
                
                <div class="filter-group">
                    <label for="status">ìƒíƒœ</label>
                    <select id="status" name="status">
                        <option value="">ì „ì²´</option>
                        <option value="pending" <?= $status_filter === 'pending' ? 'selected' : '' ?>>ê²€í†  ëŒ€ê¸°</option>
                        <option value="investigating" <?= $status_filter === 'investigating' ? 'selected' : '' ?>>ì¡°ì‚¬ ì¤‘</option>
                        <option value="fixed" <?= $status_filter === 'fixed' ? 'selected' : '' ?>>ìˆ˜ì • ì™„ë£Œ</option>
                        <option value="rejected" <?= $status_filter === 'rejected' ? 'selected' : '' ?>>ê±°ë¶€ë¨</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="severity">ì‹¬ê°ë„</label>
                    <select id="severity" name="severity">
                        <option value="">ì „ì²´</option>
                        <option value="critical" <?= $severity_filter === 'critical' ? 'selected' : '' ?>>Critical</option>
                        <option value="high" <?= $severity_filter === 'high' ? 'selected' : '' ?>>High</option>
                        <option value="medium" <?= $severity_filter === 'medium' ? 'selected' : '' ?>>Medium</option>
                        <option value="low" <?= $severity_filter === 'low' ? 'selected' : '' ?>>Low</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="category">ë¶„ë¥˜</label>
                    <select id="category" name="category">
                        <option value="">ì „ì²´</option>
                        <option value="sql_injection" <?= $category_filter === 'sql_injection' ? 'selected' : '' ?>>SQL Injection</option>
                        <option value="xss" <?= $category_filter === 'xss' ? 'selected' : '' ?>>XSS</option>
                        <option value="csrf" <?= $category_filter === 'csrf' ? 'selected' : '' ?>>CSRF</option>
                        <option value="file_upload" <?= $category_filter === 'file_upload' ? 'selected' : '' ?>>íŒŒì¼ ì—…ë¡œë“œ</option>
                        <option value="authentication" <?= $category_filter === 'authentication' ? 'selected' : '' ?>>ì¸ì¦/ì¸ê°€</option>
                        <option value="information_disclosure" <?= $category_filter === 'information_disclosure' ? 'selected' : '' ?>>ì •ë³´ ë…¸ì¶œ</option>
                        <option value="other" <?= $category_filter === 'other' ? 'selected' : '' ?>>ê¸°íƒ€</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <button type="submit" class="btn-filter">í•„í„° ì ìš©</button>
                </div>
            </form>
        </div>
        
        <?php if (!empty($reports)): ?>
        <div class="bulk-actions">
            <h3>âš¡ ì¼ê´„ ì²˜ë¦¬</h3>
            <form method="POST" class="bulk-form">
                <div class="filter-group">
                    <label for="bulk_status">ìƒíƒœ ë³€ê²½</label>
                    <select id="bulk_status" name="bulk_status" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="investigating">ì¡°ì‚¬ ì¤‘</option>
                        <option value="fixed">ìˆ˜ì • ì™„ë£Œ</option>
                        <option value="rejected">ê±°ë¶€ë¨</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="bulk_notes">ë©”ëª¨</label>
                    <input type="text" id="bulk_notes" name="bulk_notes" placeholder="ì¼ê´„ ì²˜ë¦¬ ë©”ëª¨">
                </div>
                
                <div class="filter-group">
                    <button type="submit" name="bulk_action" class="btn-filter">ì¼ê´„ ì²˜ë¦¬</button>
                </div>
            </form>
        </div>
        <?php endif; ?>
        
        <div class="reports-list">
            <h2>ğŸ“‹ ì·¨ì•½ì  ëª©ë¡ (<?= count($reports) ?>ê±´)</h2>
            <?php if (empty($reports)): ?>
                <p>ì¡°ê±´ì— ë§ëŠ” ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <?php else: ?>
                <?php foreach ($reports as $report): ?>
                <div class="report-item">
                    <div class="div priority-indicator priority-<?= $report['severity'] ?>"></div>
                    
                    <div class="report-header">
                        <div class="report-title"><?= htmlspecialchars($report['title']) ?></div>
                        <div>
                            <span class="badge severity-<?= $report['severity'] ?>">
                                <?= ucfirst($report['severity']) ?>
                            </span>
                            <span class="badge status-<?= $report['status'] ?>">
                                <?= ucfirst($report['status']) ?>
                            </span>
                        </div>
                    </div>
                    
                    <p><strong>ë¶„ë¥˜:</strong> <?= htmlspecialchars($report['category']) ?></p>
                    <p><strong>ì„¤ëª…:</strong> <?= nl2br(htmlspecialchars($report['description'])) ?></p>
                    
                    <?php if ($report['reproduction_steps']): ?>
                        <p><strong>ì¬í˜„ ë‹¨ê³„:</strong> <?= nl2br(htmlspecialchars($report['reproduction_steps'])) ?></p>
                    <?php endif; ?>
                    
                    <?php if ($report['impact']): ?>
                        <p><strong>ì˜í–¥ë„:</strong> <?= nl2br(htmlspecialchars($report['impact'])) ?></p>
                    <?php endif; ?>
                    
                    <p><strong>ì œë³´ì:</strong> <?= htmlspecialchars($report['reported_by']) ?></p>
                    <p><strong>ì œë³´ì¼:</strong> <?= $report['created_at'] ?></p>
                    
                    <?php if ($report['admin_notes']): ?>
                        <p><strong>ê´€ë¦¬ì ë©”ëª¨:</strong> <?= nl2br(htmlspecialchars($report['admin_notes'])) ?></p>
                    <?php endif; ?>
                    
                    <div class="quick-actions">
                        <form method="POST" style="display: inline;">
                            <input type="hidden" name="report_id" value="<?= $report['id'] ?>">
                            <input type="hidden" name="new_status" value="investigating">
                            <input type="hidden" name="admin_notes" value="ë¹ ë¥¸ ì¡°ì‚¬ ì‹œì‘">
                            <button type="submit" name="update_status" class="btn-quick btn-investigate">ì¡°ì‚¬ ì‹œì‘</button>
                        </form>
                        
                        <form method="POST" style="display: inline;">
                            <input type="hidden" name="report_id" value="<?= $report['id'] ?>">
                            <input type="hidden" name="new_status" value="fixed">
                            <input type="hidden" name="admin_notes" value="ë¹ ë¥¸ ìˆ˜ì • ì™„ë£Œ">
                            <button type="submit" name="update_status" class="btn-quick btn-fix">ìˆ˜ì • ì™„ë£Œ</button>
                        </form>
                        
                        <form method="POST" style="display: inline;">
                            <input type="hidden" name="report_id" value="<?= $report['id'] ?>">
                            <input type="hidden" name="new_status" value="rejected">
                            <input type="hidden" name="admin_notes" value="ë¹ ë¥¸ ê±°ë¶€">
                            <button type="submit" name="update_status" class="btn-quick btn-reject">ê±°ë¶€</button>
                        </form>
                    </div>
                    
                    <div class="status-form">
                        <form method="POST">
                            <input type="hidden" name="report_id" value="<?= $report['id'] ?>">
                            <div class="checkbox-group">
                                <input type="checkbox" name="selected_reports[]" value="<?= $report['id'] ?>" id="select_<?= $report['id'] ?>">
                                <label for="select_<?= $report['id'] ?>">ì¼ê´„ ì²˜ë¦¬ì— í¬í•¨</label>
                            </div>
                            
                            <div>
                                <label for="new_status_<?= $report['id'] ?>">ìƒíƒœ ë³€ê²½:</label>
                                <select id="new_status_<?= $report['id'] ?>" name="new_status" required>
                                    <option value="pending" <?= $report['status'] === 'pending' ? 'selected' : '' ?>>ê²€í†  ëŒ€ê¸°</option>
                                    <option value="investigating" <?= $report['status'] === 'investigating' ? 'selected' : '' ?>>ì¡°ì‚¬ ì¤‘</option>
                                    <option value="fixed" <?= $report['status'] === 'fixed' ? 'selected' : '' ?>>ìˆ˜ì • ì™„ë£Œ</option>
                                    <option value="rejected" <?= $report['status'] === 'rejected' ? 'selected' : '' ?>>ê±°ë¶€ë¨</option>
                                </select>
                            </div>
                            <div>
                                <label for="admin_notes_<?= $report['id'] ?>">ê´€ë¦¬ì ë©”ëª¨:</label>
                                <textarea id="admin_notes_<?= $report['id'] ?>" name="admin_notes" rows="3" placeholder="ìƒíƒœ ë³€ê²½ ì‚¬ìœ ë‚˜ ì¶”ê°€ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"><?= htmlspecialchars($report['admin_notes'] ?? '') ?></textarea>
                            </div>
                            <button type="submit" name="update_status" class="btn-update">ìƒíƒœ ì—…ë°ì´íŠ¸</button>
                        </form>
                    </div>
                </div>
                <?php endforeach; ?>
            <?php endif; ?>
        </div>
    </div>
</body>
</html> 