<?php
session_start();
require_once '../../src/db/db.php';
require_once '../../src/log/log_function.php';

// 관리자 권한 체크
if (!isset($_SESSION['admin'])) {
    header("Location: ../login.php");
    exit();
}

$username = $_SESSION['admin'] ?? '';

// 상태 변경 처리
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_status'])) {
    $report_id = (int)$_POST['report_id'];
    $new_status = $_POST['new_status'];
    $admin_notes = trim($_POST['admin_notes'] ?? '');
    
    $stmt = $pdo->prepare("UPDATE vulnerability_reports SET status = ?, admin_notes = ? WHERE id = ?");
    $stmt->execute([$new_status, $admin_notes, $report_id]);
    
    writeLog($pdo, $username, '취약점상태변경', '성공', "ID: $report_id, 상태: $new_status");
    echo "<script>alert('상태가 업데이트되었습니다.'); location.href='vulnerability_management.php';</script>";
    exit();
}

// 일괄 처리
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['bulk_action'])) {
    $selected_reports = $_POST['selected_reports'] ?? [];
    $bulk_status = $_POST['bulk_status'];
    $bulk_notes = trim($_POST['bulk_notes'] ?? '');
    
    if (!empty($selected_reports)) {
        $placeholders = str_repeat('?,', count($selected_reports) - 1) . '?';
        $stmt = $pdo->prepare("UPDATE vulnerability_reports SET status = ?, admin_notes = ? WHERE id IN ($placeholders)");
        $params = array_merge([$bulk_status, $bulk_notes], $selected_reports);
        $stmt->execute($params);
        
        writeLog($pdo, $username, '취약점일괄처리', '성공', "개수: " . count($selected_reports) . ", 상태: $bulk_status");
        echo "<script>alert('일괄 처리가 완료되었습니다.'); location.href='vulnerability_management.php';</script>";
        exit();
    }
}

// 필터링
$status_filter = $_GET['status'] ?? '';
$severity_filter = $_GET['severity'] ?? '';
$category_filter = $_GET['category'] ?? '';
$search_term = $_GET['search'] ?? '';

$where_conditions = [];
$params = [];

if ($status_filter) {
    $where_conditions[] = "status = ?";
    $params[] = $status_filter;
}

if ($severity_filter) {
    $where_conditions[] = "severity = ?";
    $params[] = $severity_filter;
}

if ($category_filter) {
    $where_conditions[] = "category = ?";
    $params[] = $category_filter;
}

if ($search_term) {
    $where_conditions[] = "(title LIKE ? OR description LIKE ? OR reported_by LIKE ?)";
    $search_param = "%$search_term%";
    $params[] = $search_param;
    $params[] = $search_param;
    $params[] = $search_param;
}

$where_sql = '';
if (!empty($where_conditions)) {
    $where_sql = 'WHERE ' . implode(' AND ', $where_conditions);
}

// 취약점 목록 조회
$sql = "SELECT * FROM vulnerability_reports $where_sql ORDER BY 
        CASE 
            WHEN severity = 'critical' THEN 1
            WHEN severity = 'high' THEN 2
            WHEN severity = 'medium' THEN 3
            WHEN severity = 'low' THEN 4
        END,
        created_at DESC";
$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$reports = $stmt->fetchAll();

// 통계
$total_reports = $pdo->query("SELECT COUNT(*) FROM vulnerability_reports")->fetchColumn();
$pending_reports = $pdo->query("SELECT COUNT(*) FROM vulnerability_reports WHERE status = 'pending'")->fetchColumn();
$critical_reports = $pdo->query("SELECT COUNT(*) FROM vulnerability_reports WHERE severity = 'critical'")->fetchColumn();
$fixed_reports = $pdo->query("SELECT COUNT(*) FROM vulnerability_reports WHERE status = 'fixed'")->fetchColumn();
$investigating_reports = $pdo->query("SELECT COUNT(*) FROM vulnerability_reports WHERE status = 'investigating'")->fetchColumn();
?>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>취약점 관리</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .management-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; color: #005BAC; }
        .stat-label { color: #666; margin-top: 5px; }
        .filter-section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .filter-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 5px; font-weight: 600; }
        .filter-group select, .filter-group input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn-filter { background: #005BAC; color: #fff; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-filter:hover { background: #004a8c; }
        .bulk-actions { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .bulk-form { display: grid; grid-template-columns: 1fr auto auto auto; gap: 15px; align-items: end; }
        .reports-list { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
        .report-item { border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .report-title { font-size: 18px; font-weight: 600; color: #333; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .severity-critical { background: #ff4444; color: #fff; }
        .severity-high { background: #ff8800; color: #fff; }
        .severity-medium { background: #ffcc00; color: #333; }
        .severity-low { background: #00cc00; color: #fff; }
        .status-pending { background: #ffcc00; color: #333; }
        .status-investigating { background: #0099ff; color: #fff; }
        .status-fixed { background: #00cc00; color: #fff; }
        .status-rejected { background: #ff4444; color: #fff; }
        .status-form { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .status-form select, .status-form textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .btn-update { background: #005BAC; color: #fff; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-update:hover { background: #004a8c; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; }
        .checkbox-group input[type="checkbox"] { margin: 0; }
        .priority-indicator { width: 4px; height: 100%; position: absolute; left: 0; top: 0; }
        .priority-critical { background: #ff4444; }
        .priority-high { background: #ff8800; }
        .priority-medium { background: #ffcc00; }
        .priority-low { background: #00cc00; }
        .report-item { position: relative; padding-left: 20px; }
        .quick-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-quick { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-investigate { background: #0099ff; color: #fff; }
        .btn-fix { background: #00cc00; color: #fff; }
        .btn-reject { background: #ff4444; color: #fff; }
    </style>
</head>
<body>
    <div class="management-container">
        <h1>🔒 취약점 관리</h1>
        <p>제보된 취약점들을 검토하고 상태를 관리합니다.</p>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number"><?= $total_reports ?></div>
                <div class="stat-label">총 제보</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?= $pending_reports ?></div>
                <div class="stat-label">검토 대기</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?= $critical_reports ?></div>
                <div class="stat-label">치명적 취약점</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?= $investigating_reports ?></div>
                <div class="stat-label">조사 중</div>
            </div>
            <div class="stat-card">
                <div class="stat-number"><?= $fixed_reports ?></div>
                <div class="stat-label">수정 완료</div>
            </div>
        </div>
        
        <div class="filter-section">
            <h3>🔍 필터 및 검색</h3>
            <form method="GET" class="filter-form">
                <div class="filter-group">
                    <label for="search">검색</label>
                    <input type="text" id="search" name="search" value="<?= htmlspecialchars($search_term) ?>" placeholder="제목, 설명, 제보자 검색">
                </div>
                
                <div class="filter-group">
                    <label for="status">상태</label>
                    <select id="status" name="status">
                        <option value="">전체</option>
                        <option value="pending" <?= $status_filter === 'pending' ? 'selected' : '' ?>>검토 대기</option>
                        <option value="investigating" <?= $status_filter === 'investigating' ? 'selected' : '' ?>>조사 중</option>
                        <option value="fixed" <?= $status_filter === 'fixed' ? 'selected' : '' ?>>수정 완료</option>
                        <option value="rejected" <?= $status_filter === 'rejected' ? 'selected' : '' ?>>거부됨</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="severity">심각도</label>
                    <select id="severity" name="severity">
                        <option value="">전체</option>
                        <option value="critical" <?= $severity_filter === 'critical' ? 'selected' : '' ?>>Critical</option>
                        <option value="high" <?= $severity_filter === 'high' ? 'selected' : '' ?>>High</option>
                        <option value="medium" <?= $severity_filter === 'medium' ? 'selected' : '' ?>>Medium</option>
                        <option value="low" <?= $severity_filter === 'low' ? 'selected' : '' ?>>Low</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="category">분류</label>
                    <select id="category" name="category">
                        <option value="">전체</option>
                        <option value="sql_injection" <?= $category_filter === 'sql_injection' ? 'selected' : '' ?>>SQL Injection</option>
                        <option value="xss" <?= $category_filter === 'xss' ? 'selected' : '' ?>>XSS</option>
                        <option value="csrf" <?= $category_filter === 'csrf' ? 'selected' : '' ?>>CSRF</option>
                        <option value="file_upload" <?= $category_filter === 'file_upload' ? 'selected' : '' ?>>파일 업로드</option>
                        <option value="authentication" <?= $category_filter === 'authentication' ? 'selected' : '' ?>>인증/인가</option>
                        <option value="information_disclosure" <?= $category_filter === 'information_disclosure' ? 'selected' : '' ?>>정보 노출</option>
                        <option value="other" <?= $category_filter === 'other' ? 'selected' : '' ?>>기타</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <button type="submit" class="btn-filter">필터 적용</button>
                </div>
            </form>
        </div>
        
        <?php if (!empty($reports)): ?>
        <div class="bulk-actions">
            <h3>⚡ 일괄 처리</h3>
            <form method="POST" class="bulk-form">
                <div class="filter-group">
                    <label for="bulk_status">상태 변경</label>
                    <select id="bulk_status" name="bulk_status" required>
                        <option value="">선택하세요</option>
                        <option value="investigating">조사 중</option>
                        <option value="fixed">수정 완료</option>
                        <option value="rejected">거부됨</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="bulk_notes">메모</label>
                    <input type="text" id="bulk_notes" name="bulk_notes" placeholder="일괄 처리 메모">
                </div>
                
                <div class="filter-group">
                    <button type="submit" name="bulk_action" class="btn-filter">일괄 처리</button>
                </div>
            </form>
        </div>
        <?php endif; ?>
        
        <div class="reports-list">
            <h2>📋 취약점 목록 (<?= count($reports) ?>건)</h2>
            <?php if (empty($reports)): ?>
                <p>조건에 맞는 취약점이 없습니다.</p>
            <?php else: ?>
            <table class="vul-list" style="width:100%;border-collapse:collapse;">
              <thead>
                <tr style="background:#f8f9fa;">
                  <th style="padding:10px 8px;text-align:center;">제목</th><th style="padding:10px 8px;text-align:center;">심각도</th><th style="padding:10px 8px;text-align:center;">상태</th><th style="padding:10px 8px;text-align:center;">분류</th><th style="padding:10px 8px;text-align:center;">제보자</th><th style="padding:10px 8px;text-align:center;">등록일</th><th style="padding:10px 8px;text-align:center;">관리</th>
                </tr>
              </thead>
              <tbody>
                <?php foreach ($reports as $report): ?>
                <tr class="vul-row" data-id="<?= $report['id'] ?>" style="cursor:pointer;border-bottom:1.5px solid #f0f0f0;">
                  <td style="padding:10px 8px;vertical-align:middle;text-align:center;"><?= htmlspecialchars($report['title']) ?></td>
                  <td style="padding:10px 8px;vertical-align:middle;text-align:center;"><span class="badge severity-<?= $report['severity'] ?>"><?= ucfirst($report['severity']) ?></span></td>
                  <td style="padding:10px 8px;vertical-align:middle;text-align:center;"><span class="badge status-<?= $report['status'] ?>"><?= ucfirst($report['status']) ?></span></td>
                  <td style="padding:10px 8px;vertical-align:middle;text-align:center;"><?= htmlspecialchars($report['category']) ?></td>
                  <td style="padding:10px 8px;vertical-align:middle;text-align:center;"><?= htmlspecialchars($report['reported_by']) ?></td>
                  <td style="padding:10px 8px;vertical-align:middle;text-align:center;"><?= $report['created_at'] ?></td>
                  <td style="padding:10px 8px;vertical-align:middle;text-align:center;">🔍</td>
                </tr>
                <tr class="vul-detail-row" id="detail-<?= $report['id'] ?>" style="display:none;background:#f8faff;">
                  <td colspan="7" style="padding:18px 8px;">
                    <div style="max-width:900px;margin:0 auto;">
                      <div style="margin-bottom:10px;"><strong>설명:</strong> <?= nl2br(htmlspecialchars($report['description'])) ?></div>
                      <?php if ($report['reproduction_steps']): ?>
                        <div style="margin-bottom:10px;"><strong>재현 단계:</strong> <?= nl2br(htmlspecialchars($report['reproduction_steps'])) ?></div>
                      <?php endif; ?>
                      <?php if ($report['impact']): ?>
                        <div style="margin-bottom:10px;"><strong>영향도:</strong> <?= nl2br(htmlspecialchars($report['impact'])) ?></div>
                      <?php endif; ?>
                      <?php if ($report['admin_notes']): ?>
                        <div style="margin-bottom:10px;"><strong>관리자 메모:</strong> <?= nl2br(htmlspecialchars($report['admin_notes'])) ?></div>
                      <?php endif; ?>
                      <form method="POST" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px;">
                        <input type="hidden" name="report_id" value="<?= $report['id'] ?>">
                        <?php $status = $report['status']; ?>
                        <span style="font-weight:600;">상태 변경:</span>
                        <button type="submit" name="update_status" value="investigating" class="btn-update" style="min-width:90px;" <?= $status!=='pending'?'disabled':'' ?>>조사중</button>
                        <button type="submit" name="update_status" value="fixed" class="btn-update" style="min-width:90px;" <?= $status!=='investigating'?'disabled':'' ?>>수정완료</button>
                        <button type="submit" name="update_status" value="rejected" class="btn-update" style="min-width:90px;" <?= $status==='fixed'?'':'disabled' ?>>거부됨</button>
                        <textarea name="admin_notes" rows="1" placeholder="메모" style="min-width:120px;max-width:220px;resize:horizontal;vertical-align:middle;"><?= htmlspecialchars($report['admin_notes'] ?? '') ?></textarea>
                        <button type="submit" name="save_notes" class="btn-update" style="min-width:70px;">저장</button>
                      </form>
                      <form method="POST" onsubmit="return confirm('정말 삭제하시겠습니까?');" style="text-align:right;">
                        <input type="hidden" name="delete_report_id" value="<?= $report['id'] ?>">
                        <button type="submit" name="delete_report" class="btn-update" style="background:#ff4444;min-width:90px;">삭제</button>
                      </form>
                    </div>
                  </td>
                </tr>
                <?php endforeach; ?>
              </tbody>
            </table>
            <script>
            document.querySelectorAll('.vul-row').forEach(function(row) {
              row.addEventListener('click', function(e) {
                var id = this.dataset.id;
                var detail = document.getElementById('detail-'+id);
                if(detail.style.display==='none'||!detail.style.display){
                  document.querySelectorAll('.vul-detail-row').forEach(function(row){row.style.display='none';});
                  detail.style.display='table-row';
                }else{
                  detail.style.display='none';
                }
              });
            });
            </script>
            <?php endif; ?>
        </div>
    </div>
</body>
</html> 